<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>4in1 RETRO SYSTEM - Enhanced</title>
<style>
  * { box-sizing: border-box; }
  body { margin: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; touch-action: none; font-family: 'Courier New', Courier, monospace; user-select: none; }
  #gameboy { width: 100%; max-width: 400px; height: 100vh; max-height: 850px; background-color: #d8d8d8; border-radius: 20px; display: flex; flex-direction: column; box-shadow: inset -5px -5px 15px rgba(0,0,0,0.2), 5px 5px 20px rgba(0,0,0,0.8); position: relative; overflow: hidden; }
  #screen-container { flex: 1; background-color: #444; margin: 20px 20px 10px 20px; border-radius: 10px 10px 40px 10px; display: flex; justify-content: center; align-items: center; padding: 15px; border: 3px solid #777; box-shadow: inset 2px 2px 10px rgba(0,0,0,0.5); position: relative; }
  canvas { background-color: #000; width: 100%; max-width: 280px; aspect-ratio: 1 / 1.5; image-rendering: pixelated; box-shadow: 0 0 10px rgba(0,0,0,0.8); }
  #controls { height: 280px; position: relative; background: #d8d8d8; }
  #dpad { position: absolute; left: 30px; top: 30px; width: 120px; height: 120px; }
  .d-btn { position: absolute; background-color: #333; border-radius: 4px; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.5); cursor: pointer; }
  .d-btn:active { background-color: #111; }
  #btn-up { top: 0; left: 40px; width: 40px; height: 40px; border-radius: 5px 5px 0 0; }
  #btn-down { bottom: 0; left: 40px; width: 40px; height: 40px; border-radius: 0 0 5px 5px; }
  #btn-left { top: 40px; left: 0; width: 40px; height: 40px; border-radius: 5px 0 0 5px; }
  #btn-right { top: 40px; right: 0; width: 40px; height: 40px; border-radius: 0 5px 5px 0; }
  .d-center { top: 40px; left: 40px; width: 40px; height: 40px; background-color: #333; position: absolute; }
  #action-buttons { position: absolute; right: 20px; top: 50px; width: 140px; height: 100px; transform: rotate(-15deg); }
  .a-btn { position: absolute; width: 55px; height: 55px; background-color: #b00; border-radius: 50%; color: #faa; font-weight: bold; font-size: 20px; text-align: center; line-height: 55px; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.5), 3px 3px 6px rgba(0,0,0,0.4); cursor: pointer; }
  .a-btn:active { background-color: #800; transform: translateY(2px); box-shadow: inset -2px -2px 5px rgba(0,0,0,0.5), 1px 1px 2px rgba(0,0,0,0.4); }
  #btn-b { left: 0; bottom: 0; } #btn-a { right: 0; top: 0; }
  .btn-label { position: absolute; font-size: 14px; color: #555; font-weight: bold; }
  #label-b { left: 20px; bottom: -25px; } #label-a { right: 20px; top: -25px; }
  #sys-buttons { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; }
  .s-btn-wrap { text-align: center; }
  .s-btn { width: 50px; height: 15px; background: #555; border-radius: 10px; box-shadow: inset -1px -1px 3px rgba(0,0,0,0.5); transform: rotate(-15deg); cursor: pointer; }
  .s-btn:active { background: #333; }
  .s-label { font-size: 10px; color: #555; font-weight: bold; margin-top: 5px; }
  #kb-guide { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 9px; line-height: 1.4; pointer-events: none; }
  @media (max-width: 600px) { #kb-guide { display: none; } }
</style>
</head>
<body>
<div id="gameboy">
  <div id="screen-container">
    <canvas id="gameCanvas" width="200" height="300"></canvas>
    <div id="kb-guide">
      <div><b>キーボード操作:</b></div>
      <div>矢印キー: 移動</div>
      <div>Z/Space: A</div>
      <div>X: B</div>
      <div>Shift: SELECT</div>
    </div>
  </div>
  <div id="controls">
    <div id="dpad">
      <div class="d-center"></div><div class="d-btn" id="btn-up"></div><div class="d-btn" id="btn-down"></div><div class="d-btn" id="btn-left"></div><div class="d-btn" id="btn-right"></div>
    </div>
    <div id="action-buttons">
      <div class="a-btn" id="btn-b">B</div><div class="btn-label" id="label-b">B</div><div class="a-btn" id="btn-a">A</div><div class="btn-label" id="label-a">A</div>
    </div>
    <div id="sys-buttons">
      <div class="s-btn-wrap"><div class="s-btn" id="btn-select"></div><div class="s-label">SELECT(戻る)</div></div>
    </div>
  </div>
</div>
<script>
// --- Core System & Audio ---
const ctx = document.getElementById('gameCanvas').getContext('2d');
const keys = { up: false, down: false, left: false, right: false, a: false, b: false, select: false };
const keysDown = { up: false, down: false, left: false, right: false, a: false, b: false, select: false };
let prevKeys = { ...keys };
let activeApp = null;
const AudioContext = window.AudioContext || window.webkitAudioContext; 
let audioCtx;

function initAudio() { if(!audioCtx) audioCtx = new AudioContext(); if(audioCtx.state === ‘suspended’) audioCtx.resume(); }
function playSnd(t) {
if(!audioCtx) return;
const osc = audioCtx.createOscillator();
const gn = audioCtx.createGain();
osc.connect(gn);
gn.connect(audioCtx.destination);
const n = audioCtx.currentTime;

if(t===‘sel’){
osc.type=‘sine’;
osc.frequency.setValueAtTime(880,n);
gn.gain.setValueAtTime(0.1,n);
gn.gain.linearRampToValueAtTime(0,n+0.05);
osc.start(n);
osc.stop(n+0.05);
} else if(t===‘jmp’){
osc.type=‘square’;
osc.frequency.setValueAtTime(300,n);
osc.frequency.exponentialRampToValueAtTime(600,n+0.1);
gn.gain.setValueAtTime(0.05,n);
gn.gain.linearRampToValueAtTime(0,n+0.1);
osc.start(n);
osc.stop(n+0.1);
} else if(t===‘hit’){
osc.type=‘sawtooth’;
osc.frequency.setValueAtTime(150,n);
osc.frequency.exponentialRampToValueAtTime(20,n+0.15);
gn.gain.setValueAtTime(0.1,n);
gn.gain.linearRampToValueAtTime(0,n+0.15);
osc.start(n);
osc.stop(n+0.15);
} else if(t===‘combo’){
osc.type=‘sine’;
osc.frequency.setValueAtTime(440,n);
osc.frequency.setValueAtTime(880,n+0.05);
gn.gain.setValueAtTime(0.15,n);
gn.gain.linearRampToValueAtTime(0,n+0.15);
osc.start(n);
osc.stop(n+0.15);
}
}

// Save Data System with Rankings
const SaveSys = {
data: JSON.parse(localStorage.getItem(‘4in1_save’)) || {
playerName: ‘PLAYER’,
scores: {n:0, h:0},
actStage: 1,
actLives: 3,
rpg: null,
rankings: {n:[], h:[]}
},
save() { localStorage.setItem(‘4in1_save’, JSON.stringify(this.data)); },
addScore(mode, score) {
const rank = mode === ‘normal’ ? this.data.rankings.n : this.data.rankings.h;
rank.push({name: this.data.playerName, score: score, date: Date.now()});
rank.sort((a,b) => b.score - a.score);
if(rank.length > 10) rank.splice(10);
this.save();
}
};

// Particle System
const particles = [];
function addParticle(x, y, color, type=‘star’) {
const count = type===‘explosion’ ? 8 : type===‘line’ ? 20 : 5;
for(let i=0; i<count; i++) {
particles.push({
x: x, y: y,
vx: (Math.random()-0.5)*4,
vy: (Math.random()-0.5)*4 - 1,
life: 30,
color: color,
size: type===‘explosion’ ? 2 : 1
});
}
}
function updateParticles() {
for(let i=particles.length-1; i>=0; i–) {
let p = particles[i];
p.x += p.vx; p.y += p.vy;
p.vy += 0.2;
p.life–;
if(p.life <= 0) particles.splice(i, 1);
}
}
function drawParticles() {
particles.forEach(p => {
ctx.globalAlpha = p.life / 30;
ctx.fillStyle = p.color;
ctx.fillRect(p.x, p.y, p.size, p.size);
ctx.globalAlpha = 1;
});
}

// Screen Shake
let shakeTimer = 0;
function screenShake(intensity=2) { shakeTimer = intensity; }
function applyShake() {
if(shakeTimer > 0) {
const ox = (Math.random()-0.5) * shakeTimer * 2;
const oy = (Math.random()-0.5) * shakeTimer * 2;
ctx.save();
ctx.translate(ox, oy);
shakeTimer–;
}
}
function resetShake() {
if(shakeTimer >= 0) ctx.restore();
}

// Enhanced Sprite Drawer (8x8 matrix)
const drawSprite = (x, y, color, str, size=2.5) => {
ctx.fillStyle = color;
const len = Math.sqrt(str.length);
for(let i=0; i<str.length; i++) {
if(str[i]===‘1’) ctx.fillRect(x + (i%len)*size, y + Math.floor(i/len)*size, size, size);
}
};

// Enhanced 8x8 sprites
const sprs = {
hero:“0011110001111100111111101111111011011011110011110111110001111100”,
slime:“0000000000111100011111100111111001111110001111000011110000111100”,
boss:“1111111110011001110111111001100110011001100110011111111110000001”,
skull:“0111111011000011110001111100011111000110110001100111111001111110”,
player:“0011110001111100011111000111110001111100011111000111110000111100”
};

// — Main Menu —
const Menu = {
cur: 0,
apps: [‘操作説明’, ‘テトリベーダー(N)’, ‘テトリベーダー(H)’, ‘理不尽ブラザーズ’, ‘マイクロクエスト’, ‘ONLINE対戦’, ‘オンラインランキング’],
init() { this.cur = 0; },
update() {
if(keysDown.down){ this.cur=(this.cur+1)%7; playSnd(‘sel’); }
if(keysDown.up){ this.cur=(this.cur+6)%7; playSnd(‘sel’); }
if(keysDown.a){
playSnd(‘jmp’);
if(this.cur===0) activeApp = Manual;
else if(this.cur===1) { Tetri.mode=‘normal’; activeApp = Tetri; }
else if(this.cur===2) { Tetri.mode=‘hard’; activeApp = Tetri; }
else if(this.cur===3) activeApp = Action;
else if(this.cur===4) activeApp = RPG;
else if(this.cur===5) activeApp = Online;
else if(this.cur===6) activeApp = Ranking;
activeApp.init();
}
},
draw() {
ctx.fillStyle=’#000’; ctx.fillRect(0,0,200,300);

```
// Title with glow effect
ctx.shadowBlur = 10;
ctx.shadowColor = '#0f0';
ctx.fillStyle='#0f0'; 
ctx.font='bold 16px monospace'; 
ctx.fillText('4in1 RETRO', 55, 30);
ctx.shadowBlur = 0;

ctx.fillStyle='#fff'; 
ctx.font='10px monospace';
ctx.fillText('ENHANCED EDITION', 45, 45);

for(let i=0; i<7; i++){
  ctx.fillStyle = i===this.cur?'#0f0':'#aaa'; 
  ctx.font='11px monospace';
  ctx.fillText((i===this.cur?'> ':'  ')+this.apps[i], 15, 75+i*28);
}

// Player name display
ctx.fillStyle='#888'; 
ctx.font='9px monospace';
ctx.fillText('PLAYER: '+SaveSys.data.playerName, 10, 290);
```

}
};

// — Manual —
const Manual = {
init() {},
update() { if(keysDown.select || keysDown.b) { activeApp = Menu; Menu.init(); } },
draw() {
ctx.fillStyle=’#000’; ctx.fillRect(0,0,200,300);
ctx.fillStyle=’#0f0’; ctx.font=‘bold 14px monospace’;
ctx.fillText(’【操作説明】’, 50, 25);

```
ctx.fillStyle='#fff'; ctx.font='11px monospace';
let t = [
  "","十字キー: 移動/選択",
  "Aボタン: 決定/攻撃","Bボタン: キャンセル/加速",
  "SELECT: メニューへ戻る","",
  "キーボード:","矢印キー: 移動","Z/Space: A","X: B","Shift: SELECT","",
  "データは自動保存されます"
];
t.forEach((l,i) => ctx.fillText(l, 15, 45+i*18));
```

}
};

// — Ranking Screen —
const Ranking = {
mode: ‘normal’,
input: false,
name: ‘’,
cursor: 0,
menuCursor: 0,
chars: ’ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-. ’,

init() {
this.mode = ‘normal’;
this.input = false;
this.name = ‘’;
this.cursor = 0;
this.menuCursor = 0;
},

update() {
if(keysDown.select || keysDown.b) {
if(this.input) { this.input = false; this.name = ‘’; }
else { activeApp = Menu; Menu.init(); }
return;
}

```
if(!this.input) {
  if(keysDown.left || keysDown.right) {
    this.mode = this.mode === 'normal' ? 'hard' : 'normal';
    playSnd('sel');
  }
  if(keysDown.a) { 
    this.input = true; 
    this.name = SaveSys.data.playerName;
    this.cursor = 0; 
    this.menuCursor = 0;
    playSnd('jmp'); 
  }
} else {
  // 文字選択中
  if(this.menuCursor === 0) {
    if(keysDown.right) { 
      this.cursor = (this.cursor+1)%this.chars.length; 
      playSnd('sel'); 
    }
    if(keysDown.left) { 
      this.cursor = (this.cursor+this.chars.length-1)%this.chars.length; 
      playSnd('sel'); 
    }
    if(keysDown.down) {
      let newCursor = this.cursor + 10;
      if(newCursor >= this.chars.length) {
        this.menuCursor = 1; // 決定ボタンへ
      } else {
        this.cursor = newCursor;
      }
      playSnd('sel');
    }
    if(keysDown.up) {
      let newCursor = this.cursor - 10;
      if(newCursor >= 0) {
        this.cursor = newCursor;
        playSnd('sel');
      }
    }
    if(keysDown.a) {
      if(this.name.length < 10) {
        this.name += this.chars[this.cursor];
        playSnd('jmp');
      } else {
        playSnd('hit');
      }
    }
  } else {
    // 決定ボタン選択中
    if(keysDown.up) {
      this.menuCursor = 0;
      playSnd('sel');
    }
    if(keysDown.a && this.name.length > 0) {
      SaveSys.data.playerName = this.name;
      SaveSys.save();
      this.input = false;
      playSnd('combo');
    }
  }
  
  if(keysDown.b) {
    if(this.name.length > 0) {
      this.name = this.name.slice(0, -1);
      playSnd('hit');
    } else {
      this.input = false;
      playSnd('hit');
    }
  }
}
```

},

draw() {
ctx.fillStyle=’#001’; ctx.fillRect(0,0,200,300);

```
if(!this.input) {
  ctx.fillStyle='#0ff'; ctx.font='bold 12px monospace';
  ctx.fillText('ONLINE RANKING', 45, 20);
  ctx.fillStyle='#888'; ctx.font='8px monospace';
  ctx.fillText('※ローカル保存', 60, 32);
  
  ctx.fillStyle='#fff'; ctx.font='10px monospace';
  ctx.fillText((this.mode==='normal'?'[NORMAL]':'<NORMAL>'), 30, 48);
  ctx.fillText((this.mode==='hard'?'[HARD]':'<HARD>'), 120, 48);
  
  const rank = this.mode === 'normal' ? SaveSys.data.rankings.n : SaveSys.data.rankings.h;
  
  ctx.fillStyle='#ff0'; ctx.font='9px monospace';
  ctx.fillText('RANK NAME       SCORE', 15, 66);
  
  for(let i=0; i<10; i++) {
    const entry = rank[i];
    ctx.fillStyle = i<3 ? ['#ffd700','#c0c0c0','#cd7f32'][i] : '#aaa';
    ctx.font='9px monospace';
    if(entry) {
      const name = entry.name.padEnd(10, ' ');
      const score = String(entry.score).padStart(6, ' ');
      ctx.fillText(`${String(i+1).padStart(2,' ')}. ${name} ${score}`, 15, 84+i*18);
    } else {
      ctx.fillText(`${String(i+1).padStart(2,' ')}. ----------  ----`, 15, 84+i*18);
    }
  }
  
  ctx.fillStyle='#0f0'; ctx.font='bold 10px monospace';
  ctx.fillText('プレイヤー名: '+SaveSys.data.playerName, 15, 270);
  ctx.fillStyle='#888'; ctx.font='9px monospace';
  ctx.fillText('A:名前変更 SELECT:戻る', 25, 285);
} else {
  ctx.fillStyle='#0f0'; ctx.font='bold 14px monospace';
  ctx.fillText('名前入力', 65, 25);
  
  ctx.fillStyle='#fff'; ctx.font='bold 18px monospace';
  const displayName = this.name + '_';
  ctx.fillText(displayName, 100 - displayName.length * 5, 55);
  ctx.fillStyle='#888'; ctx.font='9px monospace';
  ctx.fillText(`(${this.name.length}/10)`, 80, 70);
  
  ctx.fillStyle='#fff'; ctx.font='12px monospace';
  const gridW = 10;
  
  for(let i=0; i<this.chars.length; i++) {
    const row = Math.floor(i / gridW);
    const col = i % gridW;
    const x = 15 + col * 17;
    const y = 100 + row * 20;
    
    if(i === this.cursor && this.menuCursor === 0) {
      ctx.fillStyle='#000';
      ctx.fillRect(x-2, y-14, 15, 16);
      ctx.fillStyle='#0f0';
    } else {
      ctx.fillStyle='#aaa';
    }
    ctx.fillText(this.chars[i], x, y);
  }
  
  ctx.fillStyle = this.menuCursor === 1 ? '#0f0' : '#fff';
  ctx.font='bold 12px monospace';
  ctx.fillText((this.menuCursor === 1 ? '> ' : '  ') + '【決定】', 65, 200);
  if(this.name.length === 0) {
    ctx.fillStyle='#888';
    ctx.font='9px monospace';
    ctx.fillText('※1文字以上必要', 55, 215);
  }
  
  ctx.fillStyle='#888'; ctx.font='9px monospace';
  ctx.fillText('十字キー:選択 A:決定/追加', 25, 245);
  ctx.fillText('B:削除 SELECT:キャンセル', 25, 260);
}
```

}
};

// — Game 1: Tetrivader (Enhanced) —
const Tetri = {
mode: ‘normal’,
brd: [],
blts: [],
m: null,
sc: 0,
st: ‘play’,
dropCounter: 0,
combo: 0,

init() {
this.brd = Array(15).fill().map(()=>Array(10).fill(0));
this.px=4.5;
this.cool=0;
this.sc=0;
this.blts=[];
this.st=‘play’;
this.dropCounter=0;
this.combo=0;
this.spawn();
},

spawn() {
let t = Math.floor(Math.random()*7);
const M = [
[[1,1,1,1]],
[[1,0,0],[1,1,1]],
[[0,0,1],[1,1,1]],
[[1,1],[1,1]],
[[0,1,1],[1,1,0]],
[[0,1,0],[1,1,1]],
[[1,1,0],[0,1,1]]
];
const shape = M[t].map(r=>[…r]);
const maxX = 10 - shape[0].length;
const randomX = Math.floor(Math.random() * (maxX + 1));

```
this.m = { 
  s: shape, 
  x: randomX, 
  y: 0, 
  c: ['#0ff','#00f','#f80','#ff0','#0f0','#808','#f00'][t] 
};
if(this.hit(this.m.x, this.m.y)) this.gameover();
```

},

hit(x,y) {
for(let r=0; r<this.m.s.length; r++) {
for(let c=0; c<this.m.s[0].length; c++) {
if(this.m.s[r][c]) {
let nx = x + c, ny = y + r;
if(nx<0 || nx>=10 || ny>=15) return true;
if(ny>=0 && this.brd[ny][nx]) return true;
}
}
}
return false;
},

gameover() {
this.st=‘over’;
let high = this.mode===‘normal’ ? SaveSys.data.scores.n : SaveSys.data.scores.h;
if(this.sc > high) {
if(this.mode===‘normal’) SaveSys.data.scores.n = this.sc;
else SaveSys.data.scores.h = this.sc;
SaveSys.save();
}
SaveSys.addScore(this.mode, this.sc);
},

update() {
if(keysDown.select) { activeApp=Menu; Menu.init(); return; }
if(this.st===‘over’) {
if(keysDown.a||keysDown.b) { activeApp=Menu; Menu.init(); }
return;
}

```
if(keys.left) this.px=Math.max(0,this.px-0.15); 
if(keys.right) this.px=Math.min(9,this.px+0.15);

if(keysDown.a && this.cool<=0) { 
  this.blts.push({x:this.px+0.5, y:14}); 
  this.cool=10; 
  playSnd('jmp'); 
  addParticle(this.px*20+10, 14*20, '#ff0', 'star');
}
if(this.cool>0) this.cool--;

// Bullets
for(let i=this.blts.length-1; i>=0; i--) {
  let b=this.blts[i]; 
  b.y-=0.6; 
  let h=false; 
  let bx=Math.floor(b.x), by=Math.floor(b.y);
  
  if(by>=0 && by<15 && bx>=0 && bx<10 && this.brd[by][bx]) { 
    this.brd[by][bx]=0; 
    h=true; 
    this.sc+=5;
    this.combo++;
    playSnd('hit'); 
    addParticle(bx*20+10, by*20+10, '#ff0', 'explosion');
    screenShake(2);
  } else if(this.m && by>=this.m.y && by<this.m.y+this.m.s.length && bx>=this.m.x && bx<this.m.x+this.m.s[0].length) {
    let localY = by - this.m.y, localX = bx - this.m.x;
    if(this.m.s[localY] && this.m.s[localY][localX]) { 
      this.m.s[localY][localX]=0; 
      h=true; 
      this.sc+=10; 
      this.combo++;
      playSnd('hit');
      addParticle(bx*20+10, by*20+10, this.m.c, 'explosion');
      screenShake(3);
      
      let isEmpty = true;
      for(let r=0; r<this.m.s.length; r++) {
        for(let c=0; c<this.m.s[r].length; c++) {
          if(this.m.s[r][c]) isEmpty = false;
        }
      }
      if(isEmpty) { 
        this.sc+=50 + this.combo*5; 
        playSnd('combo');
        addParticle(100, 150, '#0f0', 'explosion');
        screenShake(5);
        this.spawn(); 
      }
    }
  }
  if(h||b.y<0) this.blts.splice(i,1);
}

// Mino falling
let baseSpeed = this.mode==='hard' ? 15 : 25;
let dropSpeed = keys.b ? 3 : 1;
this.dropCounter += dropSpeed;

if(this.dropCounter >= baseSpeed) {
  this.dropCounter = 0;
  if(this.m) {
    this.m.y++;
    if(this.hit(this.m.x, this.m.y)) {
      this.m.y--;
      for(let r=0; r<this.m.s.length; r++) {
        for(let c=0; c<this.m.s[0].length; c++) {
          if(this.m.s[r][c] && this.m.y+r>=0) {
            this.brd[this.m.y+r][this.m.x+c]=this.m.c;
          }
        }
      }
      
      // Line clear
      let linesCleared = 0;
      for(let r=14; r>=0; r--) {
        if(this.brd[r].every(v=>v!==0)) { 
          this.brd.splice(r,1); 
          this.brd.unshift(Array(10).fill(0)); 
          this.sc+=100; 
          linesCleared++;
          playSnd('combo');
          addParticle(100, r*20, '#fff', 'line');
          screenShake(4);
          r++; 
        }
      }
      if(linesCleared > 0) this.combo = 0;
      this.spawn();
    }
  }
}

let pLeft = Math.floor(this.px);
let pRight = Math.floor(Math.min(9, this.px+0.9));
if(this.brd[14][pLeft] || this.brd[14][pRight]) this.gameover();

updateParticles();
```

},

draw() {
applyShake();
ctx.fillStyle=’#000’; ctx.fillRect(0,0,200,300);

```
const db = (x,y,c)=>{ 
  ctx.fillStyle=c; 
  ctx.fillRect(x*20,y*20,20,20); 
  ctx.fillStyle='rgba(255,255,255,0.2)';
  ctx.fillRect(x*20, y*20, 20, 3);
  ctx.fillRect(x*20, y*20, 3, 20);
  ctx.strokeStyle='#000'; 
  ctx.strokeRect(x*20,y*20,20,20); 
};

for(let r=0; r<15; r++) {
  for(let c=0; c<10; c++) {
    if(this.brd[r][c]) db(c,r,this.brd[r][c]);
  }
}

if(this.m) {
  for(let r=0; r<this.m.s.length; r++) {
    for(let c=0; c<this.m.s[0].length; c++) {
      if(this.m.s[r][c]) db(this.m.x+c,this.m.y+r,this.m.c);
    }
  }
}

ctx.fillStyle='#ff0'; 
this.blts.forEach(b=>ctx.fillRect(b.x*20-2,b.y*20-8,4,12));

// Enhanced player sprite
drawSprite(this.px*20, 14*20+5, '#fff', sprs.player, 2.5);

drawParticles();

ctx.fillStyle='#fff'; 
ctx.font='10px monospace';
let hi = this.mode==='normal' ? SaveSys.data.scores.n : SaveSys.data.scores.h;
ctx.fillText(`SC:${this.sc} HI:${hi}`, 5, 12);

if(this.combo > 2) {
  ctx.fillStyle='#f0f'; 
  ctx.font='bold 12px monospace';
  ctx.fillText(`COMBO x${this.combo}`, 120, 12);
}

if(this.st==='over') { 
  ctx.fillStyle='rgba(0,0,0,0.8)'; 
  ctx.fillRect(0,100,200,60); 
  ctx.fillStyle='#f00'; 
  ctx.font='bold 14px monospace';
  ctx.fillText('GAMEOVER', 55, 125);
  ctx.font='10px monospace';
  ctx.fillText('(A) Menu', 65, 145);
}
resetShake();
```

}
};

// — Game 2: Unreasonable Bros (Enhanced) —
const Action = {
st: ‘play’,
map: [],
traps: [],
ens: [],
p: {x:20, y:200, vx:0, vy:0, anim:0},

init() { this.load(); },

load() {
this.st=‘play’;
this.p={x:20, y:200, vx:0, vy:0, anim:0};
this.map=[];
this.traps=[];
this.ens=[];

```
for(let i=0; i<40; i++) {
  let h = (i>5 && i<35 && Math.random()<0.2); 
  this.map.push(h?0:1);
  
  if(h && Math.random()<0.5) {
    this.traps.push({x:i*20-10, y:180, t:'hidden', act:false});
  }
  if(!h && i>5 && Math.random()<0.1) {
    this.traps.push({x:i*20, y:260, t:'fake'});
  }
  if(!h && i>10 && Math.random()<0.2) {
    this.ens.push({x:i*20, y:240, vx:-0.5, anim:0});
  }
}
```

},

die() {
SaveSys.data.actLives–;
SaveSys.save();
playSnd(‘hit’);
screenShake(8);
addParticle(this.p.x, this.p.y, ‘#00f’, ‘explosion’);

```
if(SaveSys.data.actLives < 0) { 
  SaveSys.data.actStage=1; 
  SaveSys.data.actLives=3; 
  SaveSys.save(); 
  this.st='gameover'; 
} else {
  this.st='dead'; 
}
```

},

update() {
if(keysDown.select) { activeApp=Menu; Menu.init(); return; }

```
if(this.st!=='play') { 
  if(keysDown.a) { 
    if(this.st==='clear') { 
      activeApp=Menu; 
      Menu.init(); 
    } else {
      this.load(); 
    }
  } 
  return; 
}

if(keys.left) this.p.vx-=0.5; 
if(keys.right) this.p.vx+=0.5;
this.p.vx*=0.8; 
this.p.vy+=0.6;
this.p.anim = (this.p.anim + Math.abs(this.p.vx)) % 360;

let nx=this.p.x+this.p.vx, ny=this.p.y+this.p.vy, grnd=false;
let gx=Math.floor(nx/20);

if(gx>=0 && gx<this.map.length && ny>260 && ny<280 && this.map[gx]===1) { 
  ny=260; 
  this.p.vy=0; 
  grnd=true; 
}

for(let t of this.traps) {
  if(t.t==='hidden') {
    if(!t.act && ny<t.y+20 && this.p.y>=t.y+20 && Math.abs(nx-t.x)<15){ 
      t.act=true; 
      this.p.vy*=-1; 
      playSnd('hit'); 
      addParticle(t.x, t.y, '#a52', 'explosion');
    }
    if(t.act && ny>t.y-20 && ny<t.y+20 && Math.abs(nx-t.x)<20) { 
      if(this.p.y<=t.y-20){ 
        ny=t.y-20; 
        this.p.vy=0; 
        grnd=true; 
      } else {
        nx=this.p.x; 
      }
    }
  }
  if(t.t==='fake') {
    let tx = Math.floor(t.x/20);
    if(tx>=0 && tx<this.map.length && gx===tx && this.map[tx]===1 && ny===260 && grnd) {
      this.map[tx]=0; 
      playSnd('hit');
      addParticle(t.x, 270, '#c84', 'explosion');
    }
  }
}

for(let e of this.ens) {
  e.x += e.vx; 
  e.anim = (e.anim + Math.abs(e.vx)*2) % 360;
  let egx = Math.floor(e.x/20);
  let egxR = Math.floor((e.x+19)/20);
  
  if((egx>=0 && egx<this.map.length && this.map[egx]===0) || 
     (egxR>=0 && egxR<this.map.length && this.map[egxR]===0)) {
    e.vx*=-1;
  }
  
  if(Math.abs(nx-e.x)<15 && Math.abs(ny-e.y)<15) {
    if(this.p.vy>0 && ny<e.y+10) { 
      e.y=999; 
      this.p.vy=-5; 
      playSnd('hit'); 
      addParticle(e.x, e.y, '#a00', 'explosion');
      screenShake(4);
    } else {
      this.die(); 
    }
  }
}

if(grnd && keysDown.a){ 
  this.p.vy=-9; 
  playSnd('jmp'); 
  addParticle(this.p.x+10, this.p.y+20, '#fff', 'star');
}

this.p.x=Math.max(0,nx); 
this.p.y=ny;

if(this.p.y>320) this.die();

if(this.p.x>750) { 
  SaveSys.data.actStage++; 
  SaveSys.save();
  
  if(SaveSys.data.actStage>3){ 
    this.st='clear'; 
    SaveSys.data.actStage=1; 
    SaveSys.save(); 
  } else {
    this.load(); 
  }
}

updateParticles();
```

},

draw() {
applyShake();
ctx.fillStyle=’#6cf’;
ctx.fillRect(0,0,200,300);

```
let cx = Math.max(0, Math.min(600, this.p.x-100));

ctx.fillStyle='#c84'; 
for(let i=0; i<40; i++) {
  if(this.map[i]===1) {
    ctx.fillRect(i*20-cx, 280, 20, 20);
    ctx.fillStyle='rgba(255,255,255,0.3)';
    ctx.fillRect(i*20-cx, 280, 20, 3);
    ctx.fillStyle='#c84';
  }
}

for(let t of this.traps) {
  if(t.t==='hidden' && t.act) { 
    ctx.fillStyle='#a52'; 
    ctx.fillRect(t.x-cx, t.y, 20, 20); 
  }
}

for(let e of this.ens) {
  if(e.y<300) {
    const offsetY = Math.sin(e.anim * Math.PI / 180) * 2;
    drawSprite(e.x-cx, e.y+offsetY, '#a00', sprs.skull);
  }
}

if(this.st!=='dead' && this.st!=='gameover') {
  drawSprite(this.p.x-cx, this.p.y, '#00f', sprs.hero);
}

drawParticles();

ctx.fillStyle='#000'; 
ctx.font='12px monospace'; 
ctx.fillText(`STAGE ${SaveSys.data.actStage}  残機:${SaveSys.data.actLives}`, 5, 20);

if(this.st==='dead' || this.st==='gameover') { 
  ctx.fillStyle='rgba(0,0,0,0.8)'; 
  ctx.fillRect(0,100,200,60); 
  ctx.fillStyle='#f00'; 
  ctx.font='bold 14px monospace';
  ctx.fillText(this.st==='gameover'?'GAMEOVER':'OOPS!', 60, 125);
  ctx.font='10px monospace';
  ctx.fillText('(A) '+(this.st==='gameover'?'Menu':'Retry'), 55, 145);
}

if(this.st==='clear') { 
  ctx.fillStyle='rgba(0,0,0,0.8)'; 
  ctx.fillRect(0,100,200,60); 
  ctx.fillStyle='#0f0'; 
  ctx.font='bold 14px monospace';
  ctx.fillText('ALL CLEAR!', 50, 125);
  ctx.font='10px monospace';
  ctx.fillText('(A) Menu', 60, 145);
}
resetShake();
```

}
};

// — Game 3: Micro Quest (Enhanced) —
const RPG = {
st: ‘map’,
msg: ‘’,
mIdx: 0,
map:[],
p: null,
en: null,
anim: 0,

init() {
if(SaveSys.data.rpg) {
this.p = JSON.parse(JSON.stringify(SaveSys.data.rpg));
} else {
this.p = {x:1, y:1, hp:30, mhp:30, atk:5, gld:0, lv:1, exp:0};
}
this.st=‘map’;
this.anim=0;
this.genMap();
},

genMap() {
this.map = Array(12).fill().map(()=>Array(10).fill(0));

```
for(let r=0; r<12; r++) {
  for(let c=0; c<10; c++) {
    if(Math.random()<0.2) this.map[r][c]=1;
  }
}

this.map[1][1]=2; 
this.map[1][2]=0;
this.map[10][8]=3; 
this.map[10][7]=0; 
this.map[10][9]=0;
this.map[5][5]=4;
this.map[5][4]=0;
this.map[5][6]=0;

this.p.x=1; 
this.p.y=1;
```

},

msgBox(t) {
this.msg=t;
this.st=‘msg’;
playSnd(‘sel’);
},

bat(b) {
this.st=‘bat’;
this.mIdx=0;

```
if(b) {
  this.en={
    n:'魔王', 
    hp:100, 
    atk:15, 
    max:100, 
    exp:0, 
    gld:0, 
    spr:sprs.boss, 
    c:'#808'
  };
} else { 
  let l=this.p.lv; 
  this.en={
    n:'スライム', 
    hp:10+l*5, 
    atk:2+l*2, 
    max:10+l*5, 
    exp:10, 
    gld:5+l, 
    spr:sprs.slime, 
    c:'#0a0'
  }; 
}
playSnd('hit');
```

},

update() {
this.anim++;

```
if(keysDown.select) { 
  SaveSys.data.rpg = JSON.parse(JSON.stringify(this.p));
  SaveSys.save(); 
  activeApp=Menu; 
  Menu.init();
  return; 
}

if(this.st==='msg') { 
  if(keysDown.a) { 
    if(this.msg.includes("平和")) {
      SaveSys.data.rpg = null;
      SaveSys.save();
      activeApp=Menu; 
      Menu.init();
    } else {
      this.st='map';
    }
  } 
  return; 
}

if(this.st==='shop') {
  if(keysDown.up||keysDown.down) { 
    this.mIdx=1-this.mIdx; 
    playSnd('sel');
  }
  if(keysDown.a) {
    if(this.mIdx===0 && this.p.gld>=10) { 
      this.p.gld-=10; 
      this.p.hp=this.p.mhp; 
      playSnd('combo'); 
      addParticle(100, 150, '#0f0', 'star');
    } else if(this.mIdx===1 && this.p.gld>=30) { 
      this.p.gld-=30; 
      this.p.atk+=3; 
      playSnd('combo'); 
      addParticle(100, 150, '#f00', 'star');
    } else {
      playSnd('hit');
    }
  }
  if(keysDown.b) this.st='map';
  return;
}

if(this.st==='map') {
  let nx=this.p.x, ny=this.p.y;
  
  if(keysDown.up) ny--; 
  if(keysDown.down) ny++; 
  if(keysDown.left) nx--; 
  if(keysDown.right) nx++;
  
  if(nx!==this.p.x || ny!==this.p.y) {
    if(nx>=0 && nx<10 && ny>=0 && ny<12 && this.map[ny][nx]!==1) {
      this.p.x=nx; 
      this.p.y=ny;
      playSnd('sel');
      
      if(this.map[ny][nx]===3) {
        this.bat(true);
      } else if(this.map[ny][nx]===4) { 
        this.st='shop'; 
        this.mIdx=0; 
      } else if(Math.random()<0.15 && this.map[ny][nx]===0) {
        this.bat(false);
      }
    }
  }
}

if(this.st==='bat') {
  if(keysDown.up||keysDown.down) { 
    this.mIdx=1-this.mIdx; 
    playSnd('sel');
  }
  
  if(keysDown.a) {
    if(this.mIdx===0) {
      playSnd('jmp'); 
      this.en.hp -= this.p.atk;
      screenShake(3);
      addParticle(100, 120, this.en.c, 'explosion');
      
      if(this.en.hp<=0) {
        addParticle(100, 120, '#ff0', 'explosion');
        if(this.en.n==='魔王') { 
          this.msgBox("魔王を倒した！\n世界に平和が！"); 
          this.map[10][8]=0; 
        } else { 
          this.p.exp+=this.en.exp; 
          this.p.gld+=this.en.gld;
          
          if(this.p.exp>=this.p.lv*20) { 
            this.p.lv++; 
            this.p.mhp+=10; 
            this.p.atk+=2; 
            this.p.hp=this.p.mhp; 
            playSnd('combo');
            this.msgBox(`勝利！ レベルUP！\n${this.en.gld}G獲得`); 
          } else {
            this.msgBox(`勝利！\n${this.en.gld}G獲得`);
          }
        }
      } else {
        setTimeout(() => {
          this.p.hp -= this.en.atk; 
          playSnd('hit');
          screenShake(4);
          
          if(this.p.hp<=0){ 
            this.p.hp=this.p.mhp; 
            this.p.x=1; 
            this.p.y=1; 
            this.msgBox("死んでしまった。\n城へ戻る..."); 
          }
        }, 300);
      }
    } else {
      if(this.en.n==='魔王') {
        this.msgBox("逃げられない！"); 
      } else { 
        this.st='map'; 
        playSnd('sel'); 
      }
    }
  }
}

updateParticles();
```

},

draw() {
applyShake();
ctx.fillStyle=’#000’;
ctx.fillRect(0,0,200,300);

```
if(this.st==='map' || this.st==='msg') {
  for(let r=0; r<12; r++) {
    for(let c=0; c<10; c++) {
      let v=this.map[r][c]; 
      ctx.fillStyle = v===0?'#282':v===1?'#555':v===2?'#00f':v===3?'#f00':'#e90';
      ctx.fillRect(c*20, r*20+60, 20, 20);
      
      if(v===4) { 
        ctx.fillStyle='#fff'; 
        ctx.font='bold 12px sans'; 
        ctx.fillText('店', c*20+4, r*20+74); 
      }
    }
  }
  
  const offsetY = Math.sin(this.anim * 0.1) * 1;
  drawSprite(this.p.x*20, this.p.y*20+60+offsetY, '#ff0', sprs.hero);
  
  ctx.fillStyle='#fff'; 
  ctx.font='10px monospace';
  ctx.fillText(`LV:${this.p.lv} HP:${this.p.hp}/${this.p.mhp}`, 5, 20);
  ctx.fillText(`ATK:${this.p.atk} G:${this.p.gld}`, 5, 35);
}

if(this.st==='bat') {
  ctx.fillStyle='#fff'; 
  ctx.font='bold 14px monospace'; 
  ctx.fillText(this.en.n, 20, 50);
  
  ctx.fillStyle='#f00'; 
  ctx.fillRect(20, 60, 160, 10); 
  ctx.fillStyle='#0f0'; 
  ctx.fillRect(20, 60, Math.max(0,160*(this.en.hp/this.en.max)), 10);
  
  const enemyOffset = Math.sin(this.anim * 0.1) * 2;
  drawSprite(60, 100+enemyOffset, this.en.c, this.en.spr, 16);
  
  ctx.fillStyle='#fff'; 
  ctx.font='11px monospace';
  ctx.fillText(`HP: ${this.p.hp}/${this.p.mhp}`, 20, 220);
  ctx.fillText((this.mIdx===0?'> ':'  ')+'たたかう', 20, 250); 
  ctx.fillText((this.mIdx===1?'> ':'  ')+'にげる', 110, 250);
}

if(this.st==='shop') {
  ctx.fillStyle='#fff'; 
  ctx.font='bold 12px monospace'; 
  ctx.fillText('いらっしゃい！', 40, 50); 
  ctx.font='11px monospace';
  ctx.fillText(`所持金: ${this.p.gld}G`, 50, 80);
  ctx.fillText((this.mIdx===0?'> ':'  ')+'宿屋(全回復) 10G', 20, 120);
  ctx.fillText((this.mIdx===1?'> ':'  ')+'武器(ATK+3)  30G', 20, 150);
  ctx.fillText('(B)もどる', 60, 250);
}

if(this.st==='msg') {
  ctx.fillStyle='rgba(0,0,0,0.85)'; 
  ctx.fillRect(10, 100, 180, 80); 
  ctx.strokeStyle='#0f0'; 
  ctx.lineWidth=2;
  ctx.strokeRect(10, 100, 180, 80);
  ctx.lineWidth=1;
  ctx.fillStyle='#fff'; 
  ctx.font='11px monospace';
  
  let l=this.msg.split('\n'); 
  for(let i=0; i<l.length; i++) {
    ctx.fillText(l[i], 20, 130+i*20); 
  }
  ctx.fillText('▼(A)', 150, 170);
}

drawParticles();
resetShake();
```

}
};

// — Game 4: Online Battle (Enhanced) —
const Online = {
st: ‘wait’,
tmr: 0,
p1:{y:130, s:0},
p2:{y:130, s:0, n:’’},
blt:null,
trail: [],

init() {
this.st=‘wait’;
this.tmr=60;
this.p1.s=0;
this.p1.y=130;
this.p2.s=0;
this.p2.y=130;
this.p2.n=’’;
this.trail=[];
},

update() {
if(keysDown.select) { activeApp=Menu; Menu.init(); return; }

```
if(this.st==='wait') {
  this.tmr--; 
  if(this.tmr<=0) { 
    let nms=["Tanaka","xX_Slayer_Xx","Gamer99","Pikachu","Bot_Alpha","Shadow","Nova","Blaze"];
    this.p2.n=nms[Math.floor(Math.random()*nms.length)]; 
    this.st='play'; 
    this.resetB(); 
  }
} else if(this.st==='play') {
  if(keys.up) this.p1.y = Math.max(0, this.p1.y-3);
  if(keys.down) this.p1.y = Math.min(260, this.p1.y+3);
  
  if(this.blt && this.blt.vx>0) { 
    if(this.p2.y+20 < this.blt.y) this.p2.y+=2; 
    else if(this.p2.y+20 > this.blt.y) this.p2.y-=2; 
  }
  
  if(this.blt) {
    this.trail.push({x:this.blt.x, y:this.blt.y, life:5});
    for(let i=this.trail.length-1; i>=0; i--) {
      this.trail[i].life--;
      if(this.trail[i].life<=0) this.trail.splice(i,1);
    }
    
    this.blt.x += this.blt.vx; 
    this.blt.y += this.blt.vy;
    
    if(this.blt.y<0 || this.blt.y>290) {
      this.blt.vy*=-1;
      screenShake(2);
    }
    
    if(this.blt.x<25 && Math.abs((this.p1.y+20)-this.blt.y)<20) { 
      this.blt.vx = Math.abs(this.blt.vx) * 1.05;
      this.blt.x = 25; 
      playSnd('jmp'); 
      addParticle(25, this.p1.y+20, '#0f0', 'explosion');
      screenShake(3);
    }
    if(this.blt.x>165 && Math.abs((this.p2.y+20)-this.blt.y)<20) { 
      this.blt.vx = -Math.abs(this.blt.vx) * 1.05;
      this.blt.x = 165;
      playSnd('jmp'); 
      addParticle(175, this.p2.y+20, '#f00', 'explosion');
      screenShake(3);
    }
    
    if(this.blt.x<0) { 
      this.p2.s++; 
      playSnd('hit'); 
      addParticle(0, this.blt.y, '#f00', 'explosion');
      screenShake(5);
      this.resetB(); 
    }
    if(this.blt.x>200) { 
      this.p1.s++; 
      playSnd('hit'); 
      addParticle(200, this.blt.y, '#0f0', 'explosion');
      screenShake(5);
      this.resetB(); 
    }
  }
  
  if(this.p1.s>=5 || this.p2.s>=5) this.st='end';
} else if(this.st==='end') { 
  if(keysDown.a) { activeApp=Menu; Menu.init(); } 
}

updateParticles();
```

},

resetB() {
this.blt = {
x:100,
y:150,
vx: (Math.random()<0.5?3:-3),
vy:(Math.random()*4-2)
};
this.trail = [];
},

draw() {
applyShake();
ctx.fillStyle=’#113’;
ctx.fillRect(0,0,200,300);

```
if(this.st==='wait') { 
  ctx.fillStyle='#0ff'; 
  ctx.font='bold 14px monospace'; 
  ctx.fillText('MATCHING...', 50, 130);
  
  const dots = '.'.repeat((Math.floor(this.tmr/10) % 4));
  ctx.fillText(dots, 140, 130);
} else {
  ctx.strokeStyle='#444'; 
  ctx.setLineDash([5, 5]);
  ctx.beginPath(); 
  ctx.moveTo(100,0); 
  ctx.lineTo(100,300); 
  ctx.stroke();
  ctx.setLineDash([]);
  
  ctx.fillStyle='#0f0'; 
  ctx.fillRect(10, this.p1.y, 10, 40);
  ctx.fillStyle='#f00'; 
  ctx.fillRect(180, this.p2.y, 10, 40);
  
  this.trail.forEach(t => {
    ctx.globalAlpha = t.life / 5;
    ctx.fillStyle='#ff0';
    ctx.fillRect(t.x, t.y, 6, 6);
  });
  ctx.globalAlpha = 1;
  
  if(this.blt) {
    ctx.shadowBlur = 10;
    ctx.shadowColor = '#ff0';
    ctx.fillStyle='#ff0'; 
    ctx.fillRect(this.blt.x, this.blt.y, 8, 8);
    ctx.shadowBlur = 0;
  }
  
  drawParticles();
  
  ctx.fillStyle='#fff'; 
  ctx.font='10px monospace';
  ctx.fillText('YOU', 10, 20); 
  ctx.fillText(this.p2.n.slice(0,10), 120, 20);
  ctx.font='bold 24px monospace'; 
  ctx.fillText(this.p1.s, 40, 45); 
  ctx.fillText(this.p2.s, 140, 45);
  
  if(this.st==='end') {
    ctx.fillStyle='rgba(0,0,0,0.9)'; 
    ctx.fillRect(0,100,200,80);
    
    ctx.shadowBlur = 15;
    ctx.shadowColor = this.p1.s>=5?'#0f0':'#f00';
    ctx.fillStyle = this.p1.s>=5?'#0f0':'#f00';
    ctx.font='bold 18px monospace'; 
    ctx.fillText(this.p1.s>=5?'YOU WIN!':'YOU LOSE', 50, 135);
    ctx.shadowBlur = 0;
    
    ctx.font='11px monospace'; 
    ctx.fillStyle='#fff';
    ctx.fillText('(A) メニューへ', 50, 160);
  }
}
resetShake();
```

}
};

// — Input & Loop —
const setBtn=(id,k)=>{
const e=document.getElementById(id);
const p=(ev)=>{
ev.preventDefault();
keys[k]=true;
initAudio();
};
const r=(ev)=>{
ev.preventDefault();
keys[k]=false;
};
e.addEventListener(‘touchstart’,p,{passive:false});
e.addEventListener(‘touchend’,r,{passive:false});
e.addEventListener(‘mousedown’,p);
e.addEventListener(‘mouseup’,r);
e.addEventListener(‘mouseleave’,r);
};

setBtn(‘btn-up’,‘up’);
setBtn(‘btn-down’,‘down’);
setBtn(‘btn-left’,‘left’);
setBtn(‘btn-right’,‘right’);
setBtn(‘btn-a’,‘a’);
setBtn(‘btn-b’,‘b’);
setBtn(‘btn-select’,‘select’);

window.addEventListener(‘keydown’, e=>{
if(e.key===‘ArrowUp’){ keys.up=true; initAudio(); }
if(e.key===‘ArrowDown’){ keys.down=true; initAudio(); }
if(e.key===‘ArrowLeft’){ keys.left=true; initAudio(); }
if(e.key===‘ArrowRight’){ keys.right=true; initAudio(); }
if(e.key===‘z’||e.key===’ ’) { keys.a=true; initAudio(); }
if(e.key===‘x’) { keys.b=true; initAudio(); }
if(e.key===‘Shift’) { keys.select=true; initAudio(); }
});

window.addEventListener(‘keyup’, e=>{
if(e.key===‘ArrowUp’) keys.up=false;
if(e.key===‘ArrowDown’) keys.down=false;
if(e.key===‘ArrowLeft’) keys.left=false;
if(e.key===‘ArrowRight’) keys.right=false;
if(e.key===‘z’||e.key===’ ’) keys.a=false;
if(e.key===‘x’) keys.b=false;
if(e.key===‘Shift’) keys.select=false;
});

activeApp = Menu;
activeApp.init();

function loop() {
for(let k in keys) {
keysDown[k] = keys[k] && !prevKeys[k];
prevKeys[k] = keys[k];
}
activeApp.update();
activeApp.draw();
requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>

</body>
</html>